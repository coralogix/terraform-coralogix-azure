name: Terraform Validate

on:
  pull_request:
    paths:
      - '**/**/*.tf'
      - '**/*.tfvars'
      - '.github/workflows/terraform.yml'

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      modules: ${{ steps.filter.outputs.changes }}
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3
        id: filter
        with:
          filters: |
            eventhub:
              - 'modules/eventhub/**'
            blobstorage:
              - 'modules/blobstorage/**'
            blobtootel:
              - 'modules/blobtootel/**'
            diagnosticdata:
              - 'modules/diagnosticdata/**'
            storagequeue:
              - 'modules/storagequeue/**'

  validate:
    name: Validate Terraform
    needs: changes
    if: needs.changes.outputs.modules != '[]'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        module: ${{ fromJSON(needs.changes.outputs.modules) }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3
        with:
          terraform_version: 1.7.4

      - name: Terraform Format Check
        working-directory: modules/${{ matrix.module }}
        id: fmt
        run: terraform fmt -check -recursive
        continue-on-error: true

      - name: Terraform Init
        id: init
        working-directory: modules/${{ matrix.module }}
        run: terraform init -backend=false
        continue-on-error: true

      - name: Terraform Validate  
        id: validate
        working-directory: modules/${{ matrix.module }}
        run: terraform validate -no-color

      - name: Post to Github if pull_request
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@773744901bac0e8cbb5a0dc842800d45e9b2b405 # v2
        with:
          header: terraform-modules-${{ matrix.module }}
          message: |
            ## üì¶ Terraform Validation: `${{ matrix.module }}`
            
            | Check | Status |
            |-------|--------|
            | Format üñå | `${{ steps.fmt.outcome }}` |
            | Init ‚öôÔ∏è | `${{ steps.init.outcome }}` |
            | Validate ü§ñ | `${{ steps.validate.outcome }}` |
            
            <details><summary>üìã Validation Details</summary>
            
            ```
            ${{ steps.validate.outputs.stdout }}
            ```
            
            </details>
            
            ---
            *Module: `modules/${{ matrix.module }}` ‚Ä¢ Pusher: @${{ github.actor }}*
